AWSTemplateFormatVersion: "2010-09-09"
Description: Stack that will deployed across all accounts in an org so we can assume to read data using a lambda
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Deployment parameters"
        Parameters:
          - ManagementAccountRole
          - DataCollectionAccountID
          - MultiAccountRoleName
          - OrganizationalUnitIds
          - AllowModuleReadInMgmt
          - ResourcePrefix
          - RegionsInScope
          - CFNTemplateSourceBucket
      - Label:
          default: "Available modules"
        Parameters:
          - IncludeOrgDataModule
          - IncludeBudgetsModule
          - IncludeComputeOptimizerModule
          - IncludeCostAnomalyModule
          - IncludeECSChargebackModule
          - IncludeInventoryCollectorModule
          - IncludeRDSUtilizationModule
          - IncludeRightsizingModule
          - IncludeTAModule
          - IncludeTransitGatewayModule
          - IncludeHealthModule
        # - IncludeCasesModule
    ParameterLabels:
      ManagementAccountRole:
        default: "Management account role"
      DataCollectionAccountID:
        default: "Cost Account Id"
      MultiAccountRoleName:
        default: "Multi Account Role Name"
      OrganizationalUnitIds:
        default: "Comma Delimited list of Organizational Unit IDs. StackSets will deploy a read role in all AWS Accounts within those OUs. See your OU ID here: https://console.aws.amazon.com/organizations/v2/home/accounts (we recommend choosing OU ID of your Root)"
      AllowModuleReadInMgmt:
        default: "Allow creation of read roles for modules in management account"
      ResourcePrefix:
        default: "Role Prefix"
      RegionsInScope:
        default: "Comma Delimited list of AWS regions from which data about resources will be collected. Example: us-east-1,eu-west-1,ap-northeast-1 . Please note that only AWS Health module needs multi region deployment. "
      CFNTemplateSourceBucket:
        default: "DO NOT CHANGE - A bucket that contains WA-Labs CloudFormation templates. Must be always 'aws-managed-cost-intelligence-dashboards'"
      IncludeBudgetsModule:
        default: "Include AWS Budgets Collection Module"
      IncludeComputeOptimizerModule:
        default: "Include AWS Compute Optimizer Data Collection Module"
      IncludeCostAnomalyModule:
        default: "Include Cost Anomalies Data Collection Module"
      IncludeECSChargebackModule:
        default: "Include ECS Chargeback Data Collection Module"
      IncludeInventoryCollectorModule:
        default: "Include Inventory Collector Module"
      IncludeOrgDataModule:
        default: "Include AWS Organization Data Collection Module"
      IncludeRDSUtilizationModule:
        default: "Include RDS Utilization Data Collection Module"
      IncludeRightsizingModule:
        default: "Include Rightsizing Recommendations Data Collection Module"
      IncludeTAModule:
        default: "Include AWS Trusted Advisor Data Collection Module"
      IncludeTransitGatewayModule:
        default: "Include AWS TransitGateway Collection Module"
Parameters:
  ManagementAccountRole:
    Type: String
    Description: The name of the IAM role that will be deployed in the management account which can retrieve AWS Organization data. KEEP THE SAME AS WHAT IS DEPLOYED INTO MANAGEMENT ACCOUNT
    Default: Lambda-Assume-Role-Management-Account
  DataCollectionAccountID:
    Type: String
    Description: AccountId of where the collector is deployed
  MultiAccountRoleName:
    Type: String
    Description: The name of the IAM role that will be deployed from the management account to linked accounts as a read only role. KEEP THE SAME AS WHAT IS DEPLOYED INTO MANAGEMENT ACCOUNT
    Default: "Optimization-Data-Multi-Account-Role"
  OrganizationalUnitIds:
    Type: String
    AllowedPattern: ^(ou-[a-z0-9]{4,32}-[a-z0-9]{8,32}|r-[a-z0-9]{4,32})$
    Description: "(Ex: r-ab01,ou-ab01-abcd1234) List of Organizational Unit IDs you wish to collect data for. It can be a single organizational unit. The organization root ID is usually preferred to collect data from all the member accounts."
  AllowModuleReadInMgmt:
    Type: String
    Description: Allows the creation of the read data roles for modules in the management account
    AllowedValues:
      - "yes"
      - "no"
  ResourcePrefix:
    Type: String
    Description: This prefix will be placed in front of all roles created. Note you may wish to add a dash at the end to make more readable e.g. prefix-
    Default: "CID-DC-"
  RegionsInScope:
    Type: String
    Description: "Ex: us-east-1,us-east-2,us-west-1,us-west-2,eu-central-1,eu-west-1,eu-west-2,eu-west-3  if empty, the current region will be used. You can add regions later by updating the stack."
    Default: ""
    AllowedPattern: ([a-z0-9\-, ]*?$)
  CFNTemplateSourceBucket:
    Type: String
    Description: "DO NOT CHANGE - A bucket that contains WA-Labs CloudFormation templates. Must be always 'aws-managed-cost-intelligence-dashboards'"
    Default: "aws-managed-cost-intelligence-dashboards"
  IncludeBudgetsModule:
    Type: String
    Description: Collects budgets from your accounts
    AllowedValues:
      - "yes"
      - "no"
  IncludeComputeOptimizerModule:
    Type: String
    Description: Collects AWS Compute Optimizer service recommendations
    AllowedValues:
      - "yes"
      - "no"
  IncludeCostAnomalyModule:
    Type: String
    Description: "Collects AWS Cost Explorer Cost Anomalies Recommendations"
    AllowedValues:
      - "yes"
      - "no"
  IncludeECSChargebackModule:
    Type: String
    Description: Collects data which shows costs associated with ECS Tasks leveraging EC2 instances within a Cluster
    AllowedValues:
      - "yes"
      - "no"
  IncludeInventoryCollectorModule:
    Type: String
    Description: Collects data about AMIs, EBS volumes and snapshots
    AllowedValues:
      - "yes"
      - "no"
  IncludeOrgDataModule:
    Type: String
    Description: Collects AWS Organizations data such as account Id, account name, organization parent and specified tags
    Default: "yes"
    AllowedValues:
      - "yes"
     #- "no" mandatory module
  IncludeRDSUtilizationModule:
    Type: String
    Description: Collects RDS CloudWatch metrics from your accounts
    AllowedValues:
      - "yes"
      - "no"
  IncludeRightsizingModule:
    Type: String
    Description: "Collects AWS Cost Explorer Rightsizing Recommendations"
    AllowedValues:
      - "yes"
      - "no"
  IncludeTAModule:
    Type: String
    Description: Collects AWS Trusted Advisor recommendations data
    AllowedValues:
      - "yes"
      - "no"
  IncludeTransitGatewayModule:
    Type: String
    Description: Collects TransitGateway from your accounts
    AllowedValues:
      - "yes"
      - "no"
  IncludeHealthModule:
    Type: String
    Description: Collects AWS Health Events from your accounts
    AllowedValues:
      - "yes"
      - "no"
  # IncludeCasesModule:
  #   Type: String
  #   Description: Collects AWS Support Cases from your accounts
  #   AllowedValues:
  #     - "yes"
  #     - "no"

Conditions:
  DeployModuleReadInMgmt: !Or
    - !Equals [!Ref AllowModuleReadInMgmt, "yes"]
    - !Equals [!Ref IncludeHealthModule, "yes"] # Health module requires linked account module to be deployed
  NeedRegionalDeployment: !And
    - !Not [!Equals [!Ref RegionsInScope, ""]]
    - !Equals [!Ref IncludeHealthModule, "yes"] # only health module needs regional deployment as for now

Resources:

  ReadManagementAccountSpecificData:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "https://${CFNTemplateSourceBucket}.s3.amazonaws.com/cfn/data-collection/deploy-in-management-account.yaml"
      Parameters:
        DataCollectionAccountID: !Ref DataCollectionAccountID
        ManagementAccountRole: !Ref ManagementAccountRole
        ResourcePrefix: !Ref ResourcePrefix
        IncludeComputeOptimizerModule: !Ref IncludeComputeOptimizerModule
        IncludeCostAnomalyModule: !Ref IncludeCostAnomalyModule
        IncludeRightsizingModule: !Ref IncludeRightsizingModule

  # This is a linked account role to be deployed in management account. The other StackSet is not applied to management account itself
  ReadLinkedAccountDataFromManagementAccount:
    Condition: DeployModuleReadInMgmt
    Type: AWS::CloudFormation::StackSet
    Properties:
      StackSetName: !Sub "StackSet-${AWS::AccountId}-ReadDataInManagementAccount"
      TemplateURL: !Sub "https://${CFNTemplateSourceBucket}.s3.amazonaws.com/cfn/data-collection/deploy-in-linked-account.yaml"
      Description: "StackSet in charge of deploying read roles across organization accounts"
      PermissionModel: SELF_MANAGED
      OperationPreferences:
        MaxConcurrentPercentage: 100
        FailureTolerancePercentage: 0 # All must work as expected in the management account
      Parameters:
        - ParameterKey: DataCollectionAccountID
          ParameterValue: !Ref DataCollectionAccountID
        - ParameterKey: MultiAccountRoleName
          ParameterValue: !Ref MultiAccountRoleName
        - ParameterKey: ResourcePrefix
          ParameterValue: !Ref ResourcePrefix
        - ParameterKey: LeadingRegion
          ParameterValue: !Ref AWS::Region
        - ParameterKey: IncludeTAModule
          ParameterValue: !Ref IncludeTAModule
        - ParameterKey: IncludeInventoryCollectorModule
          ParameterValue: !Ref IncludeInventoryCollectorModule
        - ParameterKey: IncludeECSChargebackModule
          ParameterValue: !Ref IncludeECSChargebackModule
        - ParameterKey: IncludeRDSUtilizationModule
          ParameterValue: !Ref IncludeRDSUtilizationModule
        - ParameterKey: IncludeBudgetsModule
          ParameterValue: !Ref IncludeBudgetsModule
        - ParameterKey: IncludeTransitGatewayModule
          ParameterValue: !Ref IncludeTransitGatewayModule
        - ParameterKey: IncludeHealthModule
          ParameterValue: !Ref IncludeHealthModule
        #- ParameterKey: IncludeCasesModule
        #  ParameterValue: !Ref IncludeCasesModule
      StackInstancesGroup:
        - DeploymentTargets:
            Accounts:
              - !Ref AWS::AccountId
          Regions:
            !If
             - NeedRegionalDeployment
             - !Split [",", !Ref RegionsInScope] # use list of region
             - [!Ref AWS::Region]                # use only one current region
      Capabilities:
        - CAPABILITY_IAM
        - CAPABILITY_NAMED_IAM

  # Same stack as above but for all accounts (except management)
  DataCollectorOrgAccountModulesReadStackSet:
    Type: AWS::CloudFormation::StackSet
    Properties:
      StackSetName: !Sub "StackSet-${AWS::AccountId}-ReadDataInEachAccount"
      TemplateURL: !Sub "https://${CFNTemplateSourceBucket}.s3.amazonaws.com/cfn/data-collection/deploy-in-linked-account.yaml"
      Description: "StackSet in charge of deploying read roles across organization accounts"
      PermissionModel: SERVICE_MANAGED
      OperationPreferences:
        MaxConcurrentPercentage: 100
        FailureTolerancePercentage: 50
      AutoDeployment:
        Enabled: true
        RetainStacksOnAccountRemoval: false
      ManagedExecution:
        Active: true
      Parameters:
        - ParameterKey: DataCollectionAccountID
          ParameterValue: !Ref DataCollectionAccountID
        - ParameterKey: MultiAccountRoleName
          ParameterValue: !Ref MultiAccountRoleName
        - ParameterKey: ResourcePrefix
          ParameterValue: !Ref ResourcePrefix
        - ParameterKey: LeadingRegion
          ParameterValue: !Ref AWS::Region
        - ParameterKey: IncludeTAModule
          ParameterValue: !Ref IncludeTAModule
        - ParameterKey: IncludeInventoryCollectorModule
          ParameterValue: !Ref IncludeInventoryCollectorModule
        - ParameterKey: IncludeECSChargebackModule
          ParameterValue: !Ref IncludeECSChargebackModule
        - ParameterKey: IncludeRDSUtilizationModule
          ParameterValue: !Ref IncludeRDSUtilizationModule
        - ParameterKey: IncludeBudgetsModule
          ParameterValue: !Ref IncludeBudgetsModule
        - ParameterKey: IncludeTransitGatewayModule
          ParameterValue: !Ref IncludeTransitGatewayModule
        - ParameterKey: IncludeHealthModule
          ParameterValue: !Ref IncludeHealthModule
        #- ParameterKey: IncludeCasesModule
        #  ParameterValue: !Ref IncludeCasesModule
      StackInstancesGroup:
        - DeploymentTargets:
            OrganizationalUnitIds: !Split [",", !Ref OrganizationalUnitIds]
          Regions:
            !If
             - NeedRegionalDeployment
             - !Split [",", !Ref RegionsInScope] # use list of region
             - [!Ref AWS::Region]                # use only one current region
      Capabilities:
        - CAPABILITY_IAM
        - CAPABILITY_NAMED_IAM


Outputs:
  IncludeBudgetsModule:
    Description: 'IncludeBudgetsModule'
    Value: !Ref   IncludeBudgetsModule
  IncludeComputeOptimizerModule:
    Description: 'IncludeComputeOptimizerModule'
    Value: !Ref   IncludeComputeOptimizerModule
  IncludeCostAnomalyModule:
    Description: 'IncludeCostAnomalyModule'
    Value: !Ref   IncludeCostAnomalyModule
  IncludeECSChargebackModule:
    Description: 'IncludeECSChargebackModule'
    Value: !Ref   IncludeECSChargebackModule
  IncludeInventoryCollectorModule:
    Description: 'IncludeInventoryCollectorModule'
    Value: !Ref   IncludeInventoryCollectorModule
  IncludeOrgDataModule:
    Description: 'IncludeOrgDataModule'
    Value: !Ref   IncludeOrgDataModule
  IncludeRDSUtilizationModule:
    Description: 'IncludeRDSUtilizationModule'
    Value: !Ref   IncludeRDSUtilizationModule
  IncludeRightsizingModule:
    Description: 'IncludeRightsizingModule'
    Value: !Ref   IncludeRightsizingModule
  IncludeTAModule:
    Description: 'IncludeTAModule'
    Value: !Ref   IncludeTAModule
  IncludeTransitGatewayModule:
    Description: 'IncludeTransitGatewayModule'
    Value: !Ref   IncludeTransitGatewayModule
  IncludeHealthModule:
    Description: 'IncludeHealthModule'
    Value: !Ref   IncludeHealthModule
