---
AWSTemplateFormatVersion: '2010-09-09'
Description: Stack that will deployed across all accounts in an org so it can send event to centralized bus. 
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: 'Deployment parameters'
        Parameters:
          - DataCollectionBusArn
      - Label:
          default: 'Available modules'
        Parameters:
          - CFNTemplateSourceBucket
          - IncludeHealthModule
          - IncludeCasesModule
    ParameterLabels:
      DataCollectionBusArn:
        Description: 'Centerlized DataCollection EventBus Arn in data collection account'
      CFNTemplateSourceBucket:
        default: "DO NOT CHANGE - A bucket that contains WA-Labs CloudFormation templates. Must be always 'aws-managed-cost-intelligence-dashboards'"

Parameters:
  DataCollectionBusArn:
    Type: String
    Description: 'Centerlized DataCollection EventBus Arn in data collection account'
  CFNTemplateSourceBucket:
    Type: String
    Description: "DO NOT CHANGE - A bucket that contains WA-Labs CloudFormation templates. Must be allways 'aws-managed-cost-intelligence-dashboards'"
    Default: "aws-managed-cost-intelligence-dashboards"
  IncludeHealthModule:
    Type: String
    Description: AWS health event intelligence dashboards and insights.
    AllowedValues:
      - "yes"
      - "no"
  IncludeCasesModule:
    Type: String
    Description: AWS health module Heidi
    AllowedValues:
      - "yes"
      - "no"

Conditions:
  DeployHeathModule: !Equals [ !Ref IncludeHealthModule, "yes"]
  DeployCasesModule: !Equals [ !Ref IncludeCasesModule, "yes"]

Resources:
  EventDrivenHealthModule:
    Type: AWS::CloudFormation::Stack
    Condition: DeployHeathModule
    Properties:
      TemplateURL: !Sub "https://${CFNTemplateSourceBucket}.s3.amazonaws.com/cfn/data-collection/module-health.yaml"
      Parameters:
        DataCollectionBusArn: !Ref  DataCollectionBusArn